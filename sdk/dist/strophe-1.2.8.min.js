(function(b){(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-base64",function(){return d()})}else{c.Base64=d()}}(this,function(){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var d={encode:function(g){var e="";var o,m,k;var n,l,j,h;var f=0;do{o=g.charCodeAt(f++);m=g.charCodeAt(f++);k=g.charCodeAt(f++);n=o>>2;l=((o&3)<<4)|(m>>4);j=((m&15)<<2)|(k>>6);h=k&63;if(isNaN(m)){l=((o&3)<<4);j=h=64}else{if(isNaN(k)){h=64}}e=e+c.charAt(n)+c.charAt(l)+c.charAt(j)+c.charAt(h)}while(f<g.length);return e},decode:function(g){var e="";var o,m,k;var n,l,j,h;var f=0;g=g.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{n=c.indexOf(g.charAt(f++));l=c.indexOf(g.charAt(f++));j=c.indexOf(g.charAt(f++));h=c.indexOf(g.charAt(f++));o=(n<<2)|(l>>4);m=((l&15)<<4)|(j>>2);k=((j&3)<<6)|h;e=e+String.fromCharCode(o);if(j!=64){e=e+String.fromCharCode(m)}if(h!=64){e=e+String.fromCharCode(k)}}while(f<g.length);return e}};return d}));(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-sha1",function(){return d()})}else{c.SHA1=d()}}(this,function(){function e(B,s){B[s>>5]|=128<<(24-s%32);B[((s+64>>9)<<4)+15]=s;var C=new Array(80);var A=1732584193;var z=-271733879;var y=-1732584194;var v=271733878;var u=-1009589776;var p,n,D,r,q,o,m,l;for(p=0;p<B.length;p+=16){r=A;q=z;o=y;m=v;l=u;for(n=0;n<80;n++){if(n<16){C[n]=B[p+n]}else{C[n]=g(C[n-3]^C[n-8]^C[n-14]^C[n-16],1)}D=h(h(g(A,5),c(n,z,y,v)),h(h(u,C[n]),f(n)));u=v;v=y;y=g(z,30);z=A;A=D}A=h(A,r);z=h(z,q);y=h(y,o);v=h(v,m);u=h(u,l)}return[A,z,y,v,u]}function c(m,l,o,n){if(m<20){return(l&o)|((~l)&n)}if(m<40){return l^o^n}if(m<60){return(l&o)|(l&n)|(o&n)}return l^o^n}function f(l){return(l<20)?1518500249:(l<40)?1859775393:(l<60)?-1894007588:-899497514}function k(n,q){var p=i(n);if(p.length>16){p=e(p,n.length*8)}var l=new Array(16),o=new Array(16);for(var m=0;m<16;m++){l[m]=p[m]^909522486;o[m]=p[m]^1549556828}var r=e(l.concat(i(q)),512+q.length*8);return e(o.concat(r),512+160)}function h(l,o){var n=(l&65535)+(o&65535);var m=(l>>16)+(o>>16)+(n>>16);return(m<<16)|(n&65535)}function g(l,m){return(l<<m)|(l>>>(32-m))}function i(o){var n=[];var l=255;for(var m=0;m<o.length*8;m+=8){n[m>>5]|=(o.charCodeAt(m/8)&l)<<(24-m%32)}return n}function d(n){var o="";var l=255;for(var m=0;m<n.length*32;m+=8){o+=String.fromCharCode((n[m>>5]>>>(24-m%32))&l)}return o}function j(o){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var q="";var p,l;for(var m=0;m<o.length*4;m+=3){p=(((o[m>>2]>>8*(3-m%4))&255)<<16)|(((o[m+1>>2]>>8*(3-(m+1)%4))&255)<<8)|((o[m+2>>2]>>8*(3-(m+2)%4))&255);for(l=0;l<4;l++){if(m*8+l*6>o.length*32){q+="="}else{q+=n.charAt((p>>6*(3-l))&63)}}}return q}return{b64_hmac_sha1:function(l,m){return j(k(l,m))},b64_sha1:function(l){return j(e(i(l),l.length*8))},binb2str:d,core_hmac_sha1:k,str_hmac_sha1:function(l,m){return d(k(l,m))},str_sha1:function(l){return d(e(i(l),l.length*8))},}}));(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-md5",function(){return d()})}else{c.MD5=d()}}(this,function(l){var j=function(p,s){var r=(p&65535)+(s&65535);var q=(p>>16)+(s>>16)+(r>>16);return(q<<16)|(r&65535)};var n=function(p,q){return(p<<q)|(p>>>(32-q))};var c=function(r){var q=[];for(var p=0;p<r.length*8;p+=8){q[p>>5]|=(r.charCodeAt(p/8)&255)<<(p%32)}return q};var g=function(q){var r="";for(var p=0;p<q.length*32;p+=8){r+=String.fromCharCode((q[p>>5]>>>(p%32))&255)}return r};var o=function(r){var q="0123456789abcdef";var s="";for(var p=0;p<r.length*4;p++){s+=q.charAt((r[p>>2]>>((p%4)*8+4))&15)+q.charAt((r[p>>2]>>((p%4)*8))&15)}return s};var e=function(y,u,r,p,w,v){return j(n(j(j(u,y),j(p,v)),w),r)};var k=function(r,q,y,w,p,v,u){return e((q&y)|((~q)&w),r,q,p,v,u)};var d=function(r,q,y,w,p,v,u){return e((q&w)|(y&(~w)),r,q,p,v,u)};var m=function(r,q,y,w,p,v,u){return e(q^y^w,r,q,p,v,u)};var i=function(r,q,y,w,p,v,u){return e(y^(q|(~w)),r,q,p,v,u)};var f=function(A,u){A[u>>5]|=128<<((u)%32);A[(((u+64)>>>9)<<4)+14]=u;var z=1732584193;var y=-271733879;var w=-1732584194;var v=271733878;var t,s,r,p;for(var q=0;q<A.length;q+=16){t=z;s=y;r=w;p=v;z=k(z,y,w,v,A[q+0],7,-680876936);v=k(v,z,y,w,A[q+1],12,-389564586);w=k(w,v,z,y,A[q+2],17,606105819);y=k(y,w,v,z,A[q+3],22,-1044525330);z=k(z,y,w,v,A[q+4],7,-176418897);v=k(v,z,y,w,A[q+5],12,1200080426);w=k(w,v,z,y,A[q+6],17,-1473231341);y=k(y,w,v,z,A[q+7],22,-45705983);z=k(z,y,w,v,A[q+8],7,1770035416);v=k(v,z,y,w,A[q+9],12,-1958414417);w=k(w,v,z,y,A[q+10],17,-42063);y=k(y,w,v,z,A[q+11],22,-1990404162);z=k(z,y,w,v,A[q+12],7,1804603682);v=k(v,z,y,w,A[q+13],12,-40341101);w=k(w,v,z,y,A[q+14],17,-1502002290);y=k(y,w,v,z,A[q+15],22,1236535329);z=d(z,y,w,v,A[q+1],5,-165796510);v=d(v,z,y,w,A[q+6],9,-1069501632);w=d(w,v,z,y,A[q+11],14,643717713);y=d(y,w,v,z,A[q+0],20,-373897302);z=d(z,y,w,v,A[q+5],5,-701558691);v=d(v,z,y,w,A[q+10],9,38016083);w=d(w,v,z,y,A[q+15],14,-660478335);y=d(y,w,v,z,A[q+4],20,-405537848);z=d(z,y,w,v,A[q+9],5,568446438);v=d(v,z,y,w,A[q+14],9,-1019803690);w=d(w,v,z,y,A[q+3],14,-187363961);
    y=d(y,w,v,z,A[q+8],20,1163531501);z=d(z,y,w,v,A[q+13],5,-1444681467);v=d(v,z,y,w,A[q+2],9,-51403784);w=d(w,v,z,y,A[q+7],14,1735328473);y=d(y,w,v,z,A[q+12],20,-1926607734);z=m(z,y,w,v,A[q+5],4,-378558);v=m(v,z,y,w,A[q+8],11,-2022574463);w=m(w,v,z,y,A[q+11],16,1839030562);y=m(y,w,v,z,A[q+14],23,-35309556);z=m(z,y,w,v,A[q+1],4,-1530992060);v=m(v,z,y,w,A[q+4],11,1272893353);w=m(w,v,z,y,A[q+7],16,-155497632);y=m(y,w,v,z,A[q+10],23,-1094730640);z=m(z,y,w,v,A[q+13],4,681279174);v=m(v,z,y,w,A[q+0],11,-358537222);w=m(w,v,z,y,A[q+3],16,-722521979);y=m(y,w,v,z,A[q+6],23,76029189);z=m(z,y,w,v,A[q+9],4,-640364487);v=m(v,z,y,w,A[q+12],11,-421815835);w=m(w,v,z,y,A[q+15],16,530742520);y=m(y,w,v,z,A[q+2],23,-995338651);z=i(z,y,w,v,A[q+0],6,-198630844);v=i(v,z,y,w,A[q+7],10,1126891415);w=i(w,v,z,y,A[q+14],15,-1416354905);y=i(y,w,v,z,A[q+5],21,-57434055);z=i(z,y,w,v,A[q+12],6,1700485571);v=i(v,z,y,w,A[q+3],10,-1894986606);w=i(w,v,z,y,A[q+10],15,-1051523);y=i(y,w,v,z,A[q+1],21,-2054922799);z=i(z,y,w,v,A[q+8],6,1873313359);v=i(v,z,y,w,A[q+15],10,-30611744);w=i(w,v,z,y,A[q+6],15,-1560198380);y=i(y,w,v,z,A[q+13],21,1309151649);z=i(z,y,w,v,A[q+4],6,-145523070);v=i(v,z,y,w,A[q+11],10,-1120210379);w=i(w,v,z,y,A[q+2],15,718787259);y=i(y,w,v,z,A[q+9],21,-343485551);z=j(z,t);y=j(y,s);w=j(w,r);v=j(v,p)}return[z,y,w,v]};var h={hexdigest:function(p){return o(f(c(p),p.length*8))},hash:function(p){return g(f(c(p),p.length*8))}};return h}));(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-utils",function(){return d()})}else{c.stropheUtils=d()}}(this,function(){var c={utf16to8:function(g){var f,h;var e="";var d=g.length;for(f=0;f<d;f++){h=g.charCodeAt(f);if((h>=0)&&(h<=127)){e+=g.charAt(f)}else{if(h>2047){e+=String.fromCharCode(224|((h>>12)&15));e+=String.fromCharCode(128|((h>>6)&63));e+=String.fromCharCode(128|((h>>0)&63))}else{e+=String.fromCharCode(192|((h>>6)&31));e+=String.fromCharCode(128|((h>>0)&63))}}}return e},addCookies:function(g){var k,e,f,j,d,h,i;for(k in (g||{})){d="";h="";i="";e=g[k];f=typeof e=="object";j=escape(unescape(f?e.value:e));if(f){d=e.expires?";expires="+e.expires:"";h=e.domain?";domain="+e.domain:"";i=e.path?";path="+e.path:""}document.cookie=k+"="+j+d+h+i}}};return c}));(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-polyfill",[],function(){return d()})}else{return d()}}(this,function(){if(!Function.prototype.bind){Function.prototype.bind=function(g){var f=this;var e=Array.prototype.slice;var d=Array.prototype.concat;var c=e.call(arguments,1);return function(){return f.apply(g?g:this,d.call(c,e.call(arguments,0)))}}}if(!Array.isArray){Array.isArray=function(c){return Object.prototype.toString.call(c)==="[object Array]"}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(d){var c=this.length;var e=Number(arguments[1])||0;e=(e<0)?Math.ceil(e):Math.floor(e);if(e<0){e+=c}for(;e<c;e++){if(e in this&&this[e]===d){return e}}return -1}}}));(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5","strophe-utils","strophe-polyfill"],function(){return d.apply(this,arguments)})}else{var e=d(c.SHA1,c.Base64,c.MD5,c.stropheUtils);window.Strophe=e.Strophe;window.$build=e.$build;window.$iq=e.$iq;window.$msg=e.$msg;window.$pres=e.$pres;window.SHA1=e.SHA1;window.Base64=e.Base64;window.MD5=e.MD5;window.b64_hmac_sha1=e.SHA1.b64_hmac_sha1;window.b64_sha1=e.SHA1.b64_sha1;window.str_hmac_sha1=e.SHA1.str_hmac_sha1;window.str_sha1=e.SHA1.str_sha1}}(this,function(c,g,h,j){var f;function i(m,l){return new f.Builder(m,l)}function k(l){return new f.Builder("message",l)}function e(l){return new f.Builder("iq",l)}function d(l){return new f.Builder("presence",l)}f={VERSION:"1.2.8",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{"a":["href"],"blockquote":["style"],"br":[],"cite":["style"],"em":[],"img":["src","alt","style","height","width"],"li":["style"],"ol":["style"],"p":["style"],"span":["style"],"strong":[],"ul":["style"],"body":[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(l){for(var m=0;m<f.XHTML.tags.length;m++){if(l==f.XHTML.tags[m]){return true}}return false
},validAttribute:function(l,n){if(typeof f.XHTML.attributes[l]!=="undefined"&&f.XHTML.attributes[l].length>0){for(var m=0;m<f.XHTML.attributes[l].length;m++){if(n==f.XHTML.attributes[l][m]){return true}}}return false},validCSS:function(m){for(var l=0;l<f.XHTML.css.length;l++){if(m==f.XHTML.css[l]){return true}}return false}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,addNamespace:function(l,m){f.NS[l]=m},forEachChild:function(o,p,n){var m,l;for(m=0;m<o.childNodes.length;m++){l=o.childNodes[m];if(l.nodeType==f.ElementType.NORMAL&&(!p||this.isTagEqual(l,p))){n(l)}}},isTagEqual:function(m,l){return m.tagName==l},_xmlGenerator:null,_makeGenerator:function(){var l;if(document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){l=this._getIEXmlDom();l.appendChild(l.createElement("strophe"))}else{l=document.implementation.createDocument("jabber:client","strophe",null)}return l},xmlGenerator:function(){if(!f._xmlGenerator){f._xmlGenerator=f._makeGenerator()}return f._xmlGenerator},_getIEXmlDom:function(){var m=null;var o=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var n=0;n<o.length;n++){if(m===null){try{m=new ActiveXObject(o[n])}catch(l){m=null}}else{break}}return m},xmlElement:function(p){if(!p){return null}var r=f.xmlGenerator().createElement(p);var n,q,o;for(n=1;n<arguments.length;n++){var m=arguments[n];if(!m){continue}if(typeof(m)=="string"||typeof(m)=="number"){r.appendChild(f.xmlTextNode(m))}else{if(typeof(m)=="object"&&typeof(m.sort)=="function"){for(q=0;q<m.length;q++){var l=m[q];if(typeof(l)=="object"&&typeof(l.sort)=="function"&&l[1]!==undefined&&l[1]!==null){r.setAttribute(l[0],l[1])}}}else{if(typeof(m)=="object"){for(o in m){if(m.hasOwnProperty(o)){if(m[o]!==undefined&&m[o]!==null){r.setAttribute(o,m[o])}}}}}}}return r},xmlescape:function(l){l=l.replace(/\&/g,"&amp;");l=l.replace(/</g,"&lt;");l=l.replace(/>/g,"&gt;");l=l.replace(/'/g,"&apos;");l=l.replace(/"/g,"&quot;");return l},xmlunescape:function(l){l=l.replace(/\&amp;/g,"&");l=l.replace(/&lt;/g,"<");l=l.replace(/&gt;/g,">");l=l.replace(/&apos;/g,"'");l=l.replace(/&quot;/g,'"');return l},xmlTextNode:function(l){return f.xmlGenerator().createTextNode(l)},xmlHtmlNode:function(l){var m;if(window.DOMParser){var n=new DOMParser();m=n.parseFromString(l,"text/xml")}else{m=new ActiveXObject("Microsoft.XMLDOM");m.async="false";m.loadXML(l)}return m},getText:function(m){if(!m){return null}var n="";if(m.childNodes.length===0&&m.nodeType==f.ElementType.TEXT){n+=m.nodeValue}for(var l=0;l<m.childNodes.length;l++){if(m.childNodes[l].nodeType==f.ElementType.TEXT){n+=m.childNodes[l].nodeValue}}return f.xmlescape(n)},copyElement:function(n){var l,m;if(n.nodeType==f.ElementType.NORMAL){m=f.xmlElement(n.tagName);for(l=0;l<n.attributes.length;l++){m.setAttribute(n.attributes[l].nodeName,n.attributes[l].value)}for(l=0;l<n.childNodes.length;l++){m.appendChild(f.copyElement(n.childNodes[l]))}}else{if(n.nodeType==f.ElementType.TEXT){m=f.xmlGenerator().createTextNode(n.nodeValue)}}return m},createHtml:function(n){var q,m,o,x,l,w,s,t,v,p,r;if(n.nodeType==f.ElementType.NORMAL){x=n.nodeName.toLowerCase();if(f.XHTML.validTag(x)){try{m=f.xmlElement(x);for(q=0;q<f.XHTML.attributes[x].length;q++){l=f.XHTML.attributes[x][q];w=n.getAttribute(l);if(typeof w=="undefined"||w===null||w===""||w===false||w===0){continue}if(l=="style"&&typeof w=="object"){if(typeof w.cssText!="undefined"){w=w.cssText}}if(l=="style"){s=[];t=w.split(";");for(o=0;o<t.length;o++){v=t[o].split(":");p=v[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(f.XHTML.validCSS(p)){r=v[1].replace(/^\s*/,"").replace(/\s*$/,"");s.push(p+": "+r)}}if(s.length>0){w=s.join("; ");m.setAttribute(l,w)}}else{m.setAttribute(l,w)}}for(q=0;q<n.childNodes.length;q++){m.appendChild(f.createHtml(n.childNodes[q]))}}catch(u){m=f.xmlTextNode("")}}else{m=f.xmlGenerator().createDocumentFragment();for(q=0;q<n.childNodes.length;q++){m.appendChild(f.createHtml(n.childNodes[q]))}}}else{if(n.nodeType==f.ElementType.FRAGMENT){m=f.xmlGenerator().createDocumentFragment();for(q=0;q<n.childNodes.length;q++){m.appendChild(f.createHtml(n.childNodes[q]))}}else{if(n.nodeType==f.ElementType.TEXT){m=f.xmlTextNode(n.nodeValue)}}}return m},escapeNode:function(l){if(typeof l!=="string"){return l}return l.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(l){if(typeof l!=="string"){return l}return l.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")
},getNodeFromJid:function(l){if(l.indexOf("@")<0){return null}return l.split("@")[0]},getDomainFromJid:function(l){var m=f.getBareJidFromJid(l);if(m.indexOf("@")<0){return m}else{var n=m.split("@");n.splice(0,1);return n.join("@")}},getResourceFromJid:function(l){var m=l.split("/");if(m.length<2){return null}m.splice(0,1);return m.join("/")},getBareJidFromJid:function(l){return l?l.split("/")[0]:null},log:function(m,l){return},debug:function(l){this.log(this.LogLevel.DEBUG,l)},info:function(l){this.log(this.LogLevel.INFO,l)},warn:function(l){this.log(this.LogLevel.WARN,l)},error:function(l){this.log(this.LogLevel.ERROR,l)},fatal:function(l){this.log(this.LogLevel.FATAL,l)},serialize:function(n){var l;if(!n){return null}if(typeof(n.tree)==="function"){n=n.tree()}var p=n.nodeName;var m,o;if(n.getAttribute("_realname")){p=n.getAttribute("_realname")}l="<"+p;for(m=0;m<n.attributes.length;m++){if(n.attributes[m].nodeName!="_realname"){l+=" "+n.attributes[m].nodeName+"='"+f.xmlescape(n.attributes[m].value)+"'"}}if(n.childNodes.length>0){l+=">";for(m=0;m<n.childNodes.length;m++){o=n.childNodes[m];switch(o.nodeType){case f.ElementType.NORMAL:l+=f.serialize(o);break;case f.ElementType.TEXT:l+=f.xmlescape(o.nodeValue);break;case f.ElementType.CDATA:l+="<![CDATA["+o.nodeValue+"]]>"}}l+="</"+p+">"}else{l+="/>"}return l},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(l,m){f._connectionPlugins[l]=m}};f.Builder=function(m,l){if(m=="presence"||m=="message"||m=="iq"){if(l&&!l.xmlns){l.xmlns=f.NS.CLIENT}else{if(!l){l={xmlns:f.NS.CLIENT}}}}this.nodeTree=f.xmlElement(m,l);this.node=this.nodeTree};f.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return f.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(m){for(var l in m){if(m.hasOwnProperty(l)){if(m[l]===undefined){this.node.removeAttribute(l)}else{this.node.setAttribute(l,m[l])}}}return this},c:function(m,l,n){var o=f.xmlElement(m,l,n);this.node.appendChild(o);if(typeof n!=="string"&&typeof n!=="number"){this.node=o}return this},cnode:function(n){var m;var p=f.xmlGenerator();try{m=(p.importNode!==undefined)}catch(o){m=false}var l=m?p.importNode(n,true):f.copyElement(n);this.node.appendChild(l);this.node=l;return this},t:function(l){var m=f.xmlTextNode(l);this.node.appendChild(m);return this},h:function(m){var l=document.createElement("body");l.innerHTML=m;var n=f.createHtml(l);while(n.childNodes.length>0){this.node.appendChild(n.childNodes[0])}return this}};f.Handler=function(p,o,m,n,r,q,l){this.handler=p;this.ns=o;this.name=m;this.type=n;this.id=r;this.options=l||{matchBare:false};if(!this.options.matchBare){this.options.matchBare=false}if(this.options.matchBare){this.from=q?f.getBareJidFromJid(q):null}else{this.from=q}this.user=true};f.Handler.prototype={isMatch:function(n){var p;var o=null;if(this.options.matchBare){o=f.getBareJidFromJid(n.getAttribute("from"))}else{o=n.getAttribute("from")}p=false;if(!this.ns){p=true}else{var m=this;f.forEachChild(n,null,function(q){if(q.getAttribute("xmlns")==m.ns){p=true}});p=p||n.getAttribute("xmlns")==this.ns}var l=n.getAttribute("type");if(p&&(!this.name||f.isTagEqual(n,this.name))&&(!this.type||(Array.isArray(this.type)?this.type.indexOf(l)!=-1:l==this.type))&&(!this.id||n.getAttribute("id")==this.id)&&(!this.from||o==this.from)){return true}return false},run:function(m){var l=null;try{l=this.handler(m)}catch(n){if(n.sourceURL){f.fatal("error: "+this.handler+" "+n.sourceURL+":"+n.line+" - "+n.name+": "+n.message)}else{if(n.fileName){if(typeof(console)!="undefined"){console.trace();console.error(this.handler," - error - ",n,n.message)}f.fatal("error: "+this.handler+" "+n.fileName+":"+n.lineNumber+" - "+n.name+": "+n.message)}else{f.fatal("error: "+n.message+"\n"+n.stack)}}throw n}return l},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};f.TimedHandler=function(m,l){this.period=m;this.handler=l;this.lastCalled=new Date().getTime();this.user=true};f.TimedHandler.prototype={run:function(){this.lastCalled=new Date().getTime();return this.handler()},reset:function(){this.lastCalled=new Date().getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};f.Connection=function(l,n){this.service=l;this.options=n||{};var q=this.options.protocol||"";if(l.indexOf("ws:")===0||l.indexOf("wss:")===0||q.indexOf("ws")===0){this._proto=new f.Websocket(this)}else{this._proto=new f.Bosh(this)}this.jid="";this.domain=null;this.features=null;this._sasl_data={};this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.authenticated=false;this.connected=false;this.disconnecting=false;this.do_authentication=true;this.paused=false;this.restored=false;this._data=[];this._uniqueId=0;this._sasl_success_handler=null;
    this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100);j.addCookies(this.options.cookies);for(var m in f._connectionPlugins){if(f._connectionPlugins.hasOwnProperty(m)){var p=f._connectionPlugins[m];var o=function(){};o.prototype=p;this[m]=new o();this[m].init(this)}}};f.Connection.prototype={reset:function(){this._proto._reset();this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=false;this.connected=false;this.disconnecting=false;this.restored=false;this._data=[];this._requests=[];this._uniqueId=0},pause:function(){this.paused=true},setJid:function(l){this.jid=l;this.authzid=f.getBareJidFromJid(this.jid);this.authcid=f.getNodeFromJid(this.jid)},getJid:function(){return this.jid},resume:function(){this.paused=false},getUniqueId:function(m){var l="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(p){var o=Math.random()*16|0,n=p=="x"?o:o&3|8;return n.toString(16)});if(typeof(m)=="string"||typeof(m)=="number"){return l+":"+m}else{return l+""}},connect:function(n,o,r,q,p,l,m){this.jid=n;this.authzid=f.getBareJidFromJid(this.jid);this.authcid=m||f.getNodeFromJid(this.jid);this.pass=o;this.servtype="xmpp";this.connect_callback=r;this.disconnecting=false;this.connected=false;this.authenticated=false;this.restored=false;this.domain=f.getDomainFromJid(this.jid);this._changeConnectStatus(f.Status.CONNECTING,null);this._proto._connect(q,p,l)},attach:function(n,l,o,r,q,p,m){if(this._proto instanceof f.Bosh){this._proto._attach(n,l,o,r,q,p,m)}else{throw {name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'}}},restore:function(m,p,o,n,l){if(this._sessionCachingSupported()){this._proto._restore(m,p,o,n,l)}else{throw {name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'}}},_sessionCachingSupported:function(){if(this._proto instanceof f.Bosh){if(!JSON){return false}try{window.sessionStorage.setItem("_strophe_","_strophe_");window.sessionStorage.removeItem("_strophe_")}catch(l){return false}return true}return false},xmlInput:function(l){return},xmlOutput:function(l){return},rawInput:function(l){return},rawOutput:function(l){return},nextValidRid:function(l){return},send:function(m){if(m===null){return}if(typeof(m.sort)==="function"){for(var l=0;l<m.length;l++){this._queueData(m[l])}}else{if(typeof(m.tree)==="function"){this._queueData(m.tree())}else{this._queueData(m)}}this._proto._send()},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(m,s,n,q){var u=null;var p=this;if(typeof(m.tree)==="function"){m=m.tree()}var l=m.getAttribute("id");if(!l){l=this.getUniqueId("sendIQ");m.setAttribute("id",l)}var o=m.getAttribute("to");var r=this.jid;var t=this.addHandler(function(x){if(u){p.deleteTimedHandler(u)}var v=false;var y=x.getAttribute("from");if(y===o||(!o&&(y===f.getBareJidFromJid(r)||y===f.getDomainFromJid(r)||y===r))){v=true}if(!v){throw {name:"StropheError",message:"Got answer to IQ from wrong jid:"+y+"\nExpected jid: "+o}}var w=x.getAttribute("type");if(w=="result"){if(s){s(x)}}else{if(w=="error"){if(n){n(x)}}else{throw {name:"StropheError",message:"Got bad IQ type of "+w}}}},null,"iq",["error","result"],l);if(q){u=this.addTimedHandler(q,function(){p.deleteHandler(t);if(n){n(null)}return false})}this.send(m);return l},_queueData:function(l){if(l===null||!l.tagName||!l.childNodes){throw {name:"StropheError",message:"Cannot queue non-DOMElement."}}this._data.push(l)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(n,m){var l=new f.TimedHandler(n,m);this.addTimeds.push(l);return l},deleteTimedHandler:function(l){this.removeTimeds.push(l)},addHandler:function(q,p,n,o,s,r,m){var l=new f.Handler(q,p,n,o,s,r,m);this.addHandlers.push(l);return l},deleteHandler:function(l){this.removeHandlers.push(l);var m=this.addHandlers.indexOf(l);if(m>=0){this.addHandlers.splice(m,1)}},disconnect:function(l){this._changeConnectStatus(f.Status.DISCONNECTING,l);f.info("Disconnect was called because: "+l);if(this.connected){var m=false;this.disconnecting=true;if(this.authenticated){m=d({xmlns:f.NS.CLIENT,type:"unavailable"})}this._disconnectTimeout=this._addSysTimedHandler(3000,this._onDisconnectTimeout.bind(this));this._proto._disconnect(m)}else{f.info("Disconnect was called before Strophe connected to the server");this._proto._abortAllRequests()}},_changeConnectStatus:function(l,q){for(var m in f._connectionPlugins){if(f._connectionPlugins.hasOwnProperty(m)){var o=this[m];if(o.statusChanged){try{o.statusChanged(l,q)}catch(n){f.error(""+m+" plugin caused an exception "+"changing status: "+n)}}}}if(this.connect_callback){try{this.connect_callback(l,q)
}catch(p){f.error("User connection callback caused an "+"exception: "+p)}}},_doDisconnect:function(l){if(typeof this._idleTimeout=="number"){clearTimeout(this._idleTimeout)}if(this._disconnectTimeout!==null){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null}f.info("_doDisconnect was called");this._proto._doDisconnect();this.authenticated=false;this.disconnecting=false;this.restored=false;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(f.Status.DISCONNECTED,l);this.connected=false},_dataRecv:function(s,t){f.info("_dataRecv called");WebIM&&WebIM.config.isDebug&&f.info(JSON.stringify(s));var l=this._proto._reqToData(s);if(l===null){return}if(this.xmlInput!==f.Connection.prototype.xmlInput){if(l.nodeName===this._proto.strip&&l.childNodes.length){this.xmlInput(l.childNodes[0])}else{this.xmlInput(l)}}if(this.rawInput!==f.Connection.prototype.rawInput){if(t){this.rawInput(t)}else{this.rawInput(f.serialize(l))}}var o,m;while(this.removeHandlers.length>0){m=this.removeHandlers.pop();o=this.handlers.indexOf(m);if(o>=0){this.handlers.splice(o,1)}}while(this.addHandlers.length>0){this.handlers.push(this.addHandlers.pop())}if(this.disconnecting&&this._proto._emptyQueue()){this._doDisconnect();return}var q=l.getAttribute("type");var r,n;if(q!==null&&q=="terminate"){if(this.disconnecting){return}r=l.getAttribute("condition");n=l.getElementsByTagName("conflict");if(r!==null){if(r=="remote-stream-error"&&n.length>0){r="conflict"}this._changeConnectStatus(f.Status.CONNFAIL,r)}else{this._changeConnectStatus(f.Status.CONNFAIL,"unknown")}this._doDisconnect(r);return}var p=this;f.forEachChild(l,null,function(y){var v,w;w=p.handlers;p.handlers=[];for(v=0;v<w.length;v++){var u=w[v];try{if(u.isMatch(y)&&(p.authenticated||!u.user)){if(u.run(y)){p.handlers.push(u)}}else{p.handlers.push(u)}}catch(x){f.warn("Removing Strophe handlers due to uncaught exception: "+x.message)}}})},mechanisms:{},_connect_cb:function(t,w,u){f.info("_connect_cb was called");this.connected=true;var m;try{m=this._proto._reqToData(t)}catch(r){if(r!="badformat"){throw r}this._changeConnectStatus(f.Status.CONNFAIL,"bad-format");this._doDisconnect("bad-format")}if(!m){return}if(this.xmlInput!==f.Connection.prototype.xmlInput){if(m.nodeName===this._proto.strip&&m.childNodes.length){this.xmlInput(m.childNodes[0])}else{this.xmlInput(m)}}if(this.rawInput!==f.Connection.prototype.rawInput){if(u){this.rawInput(u)}else{this.rawInput(f.serialize(m))}}var n=this._proto._connect_cb(m);if(n===f.Status.CONNFAIL){return}this._authentication.sasl_scram_sha1=false;this._authentication.sasl_plain=false;this._authentication.sasl_digest_md5=false;this._authentication.sasl_anonymous=false;this._authentication.legacy_auth=false;var p;if(m.getElementsByTagNameNS){p=m.getElementsByTagNameNS(f.NS.STREAM,"features").length>0}else{p=m.getElementsByTagName("stream:features").length>0||m.getElementsByTagName("features").length>0}var v=m.getElementsByTagName("mechanism");var l=[];var o,q,s=false;if(!p){this._proto._no_auth_received(w);return}if(v.length>0){for(o=0;o<v.length;o++){q=f.getText(v[o]);if(this.mechanisms[q]){l.push(this.mechanisms[q])}}}this._authentication.legacy_auth=m.getElementsByTagName("auth").length>0;s=this._authentication.legacy_auth||l.length>0;if(!s){this._proto._no_auth_received(w);return}if(this.do_authentication!==false){this.authenticate(l)}},authenticate:function(m){var p;for(p=0;p<m.length-1;++p){var l=p;for(var o=p+1;o<m.length;++o){if(m[o].prototype.priority>m[l].prototype.priority){l=o}}if(l!=p){var r=m[p];m[p]=m[l];m[l]=r}}var q=false;for(p=0;p<m.length;++p){if(!m[p].prototype.test(this)){continue}this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new m[p]();this._sasl_mechanism.onStart(this);var s=i("auth",{xmlns:f.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var n=this._sasl_mechanism.onChallenge(this,null);s.t(g.encode(n))}this.send(s.tree());q=true;break}if(!q){if(f.getNodeFromJid(this.jid)===null){this._changeConnectStatus(f.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");this.disconnect("x-strophe-bad-non-anon-jid")}else{this._changeConnectStatus(f.Status.AUTHENTICATING,null);this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1");this.send(e({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).tree())}}},_sasl_challenge_cb:function(n){var m=g.decode(f.getText(n));var l=this._sasl_mechanism.onChallenge(this,m);var o=i("response",{xmlns:f.NS.SASL});if(l!==""){o.t(g.encode(l))}this.send(o.tree());return true},_auth1_cb:function(l){var m=e({type:"set",id:"_auth_2"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).up().c("password").t(this.pass);
    if(!f.getResourceFromJid(this.jid)){this.jid=f.getBareJidFromJid(this.jid)+"/strophe"}m.up().c("resource",{}).t(f.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(m.tree());return false},_sasl_success_cb:function(n){if(this._sasl_data["server-signature"]){var l;var q=g.decode(f.getText(n));var p=/([a-z]+)=([^,]+)(,|$)/;var o=q.match(p);if(o[1]=="v"){l=o[2]}if(l!=this._sasl_data["server-signature"]){this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._sasl_data={};return this._sasl_failure_cb(null)}}f.info("SASL authentication succeeded.");if(this._sasl_mechanism){this._sasl_mechanism.onSuccess()}this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}var m=[];var r=function(s,t){while(s.length){this.deleteHandler(s.pop())}this._sasl_auth1_cb.bind(this)(t);return false};m.push(this._addSysHandler(function(s){r.bind(this)(m,s)}.bind(this),null,"stream:features",null,null));m.push(this._addSysHandler(function(s){r.bind(this)(m,s)}.bind(this),f.NS.STREAM,"features",null,null));this._sendRestart();return false},_sasl_auth1_cb:function(m){this.features=m;var l,p;for(l=0;l<m.childNodes.length;l++){p=m.childNodes[l];if(p.nodeName=="bind"){this.do_bind=true}if(p.nodeName=="session"){this.do_session=true}}if(!this.do_bind){this._changeConnectStatus(f.Status.AUTHFAIL,null);return false}else{this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var n=f.getResourceFromJid(this.jid);if(n){try{this.send(e({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).c("resource",{}).t(n).up().c("os").t("webim").up().c("device_uuid").t("device_uuid").up().c("is_manual_login").t("true").tree())}catch(o){console.log("Bind Error: ",o.message)}}else{this.send(e({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).tree())}}return false},_sasl_bind_cb:function(l){if(l.getAttribute("type")=="error"){f.info("SASL binding failed.");var m=l.getElementsByTagName("conflict"),p;if(m.length>0){p="conflict"}this._changeConnectStatus(f.Status.AUTHFAIL,p);return false}var o=l.getElementsByTagName("bind");var n;if(o.length>0){n=o[0].getElementsByTagName("jid");if(n.length>0){this.jid=f.getText(n[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2");this.send(e({type:"set",id:"_session_auth_2"}).c("session",{xmlns:f.NS.SESSION}).tree())}else{this.authenticated=true;this._changeConnectStatus(f.Status.CONNECTED,null)}}}else{f.info("SASL binding failed.");this._changeConnectStatus(f.Status.AUTHFAIL,null);return false}},_sasl_session_cb:function(l){if(l.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(f.Status.CONNECTED,null)}else{if(l.getAttribute("type")=="error"){f.info("Session creation failed.");this._changeConnectStatus(f.Status.AUTHFAIL,null);return false}}return false},_sasl_failure_cb:function(l){if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null}if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}if(this._sasl_mechanism){this._sasl_mechanism.onFailure()}this._changeConnectStatus(f.Status.AUTHFAIL,null);return false},_auth2_cb:function(l){if(l.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(f.Status.CONNECTED,null)}else{if(l.getAttribute("type")=="error"){this._changeConnectStatus(f.Status.AUTHFAIL,null);this.disconnect("authentication failed")}}return false},_addSysTimedHandler:function(n,m){var l=new f.TimedHandler(n,m);l.user=false;this.addTimeds.push(l);return l},_addSysHandler:function(p,o,m,n,q){var l=new f.Handler(p,o,m,n,q);l.user=false;this.addHandlers.push(l);return l},_onDisconnectTimeout:function(){f.info("_onDisconnectTimeout was called");this._changeConnectStatus(f.Status.CONNTIMEOUT,null);this._proto._onDisconnectTimeout();this._doDisconnect();return false},_onIdle:function(){var m,o,p,n;while(this.addTimeds.length>0){this.timedHandlers.push(this.addTimeds.pop())}while(this.removeTimeds.length>0){o=this.removeTimeds.pop();m=this.timedHandlers.indexOf(o);if(m>=0){this.timedHandlers.splice(m,1)}}var l=new Date().getTime();n=[];for(m=0;m<this.timedHandlers.length;m++){o=this.timedHandlers[m];if(this.authenticated||!o.user){p=o.lastCalled+o.period;if(p-l<=0){if(o.run()){n.push(o)}}else{n.push(o)}}}this.timedHandlers=n;clearTimeout(this._idleTimeout);this._proto._onIdle();if(this.connected){this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)}}};f.SASLMechanism=function(l,n,m){this.name=l;this.isClientFirst=n;this.priority=m};f.SASLMechanism.prototype={test:function(l){return true},onStart:function(l){this._connection=l
},onChallenge:function(l,m){throw new Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};f.SASLAnonymous=function(){};f.SASLAnonymous.prototype=new f.SASLMechanism("ANONYMOUS",false,10);f.SASLAnonymous.prototype.test=function(l){return l.authcid===null};f.Connection.prototype.mechanisms[f.SASLAnonymous.prototype.name]=f.SASLAnonymous;f.SASLPlain=function(){};f.SASLPlain.prototype=new f.SASLMechanism("PLAIN",true,20);f.SASLPlain.prototype.test=function(l){return l.authcid!==null};f.SASLPlain.prototype.onChallenge=function(m){var l=m.authzid;l=l+"\u0000";l=l+m.authcid;l=l+"\u0000";l=l+m.pass;return j.utf16to8(l)};f.Connection.prototype.mechanisms[f.SASLPlain.prototype.name]=f.SASLPlain;f.SASLSHA1=function(){};f.SASLSHA1.prototype=new f.SASLMechanism("SCRAM-SHA-1",true,40);f.SASLSHA1.prototype.test=function(l){return l.authcid!==null};f.SASLSHA1.prototype.onChallenge=function(m,n,o){var p=o||h.hexdigest(Math.random()*1234567890);var l="n="+j.utf16to8(m.authcid);l+=",r=";l+=p;m._sasl_data.cnonce=p;m._sasl_data["client-first-message-bare"]=l;l="n,,"+l;this.onChallenge=function(z,I){var G,t,D,w,u,B,E,C,q;var r,A,F;var y="c=biws,";var x=z._sasl_data["client-first-message-bare"]+","+I+",";var H=z._sasl_data.cnonce;var v=/([a-z]+)=([^,]+)(,|$)/;while(I.match(v)){var s=I.match(v);I=I.replace(s[0],"");switch(s[1]){case"r":G=s[2];break;case"s":t=s[2];break;case"i":D=s[2];break}}if(G.substr(0,H.length)!==H){z._sasl_data={};return z._sasl_failure_cb()}y+="r="+G;x+=y;t=g.decode(t);t+="\x00\x00\x00\x01";q=j.utf16to8(z.pass);w=B=c.core_hmac_sha1(q,t);for(E=1;E<D;E++){u=c.core_hmac_sha1(q,c.binb2str(B));for(C=0;C<5;C++){w[C]^=u[C]}B=u}w=c.binb2str(w);r=c.core_hmac_sha1(w,"Client Key");A=c.str_hmac_sha1(w,"Server Key");F=c.core_hmac_sha1(c.str_sha1(c.binb2str(r)),x);z._sasl_data["server-signature"]=c.b64_hmac_sha1(A,x);for(C=0;C<5;C++){r[C]^=F[C]}y+=",p="+g.encode(c.binb2str(r));return y}.bind(this);return l};f.Connection.prototype.mechanisms[f.SASLSHA1.prototype.name]=f.SASLSHA1;f.SASLMD5=function(){};f.SASLMD5.prototype=new f.SASLMechanism("DIGEST-MD5",false,30);f.SASLMD5.prototype.test=function(l){return l.authcid!==null};f.SASLMD5.prototype._quote=function(l){return'"'+l.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};f.SASLMD5.prototype.onChallenge=function(m,x,t){var n=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;var y=t||h.hexdigest(""+(Math.random()*1234567890));var u="";var z=null;var v="";var l="";var s;while(x.match(n)){s=x.match(n);x=x.replace(s[0],"");s[2]=s[2].replace(/^"(.+)"$/,"$1");switch(s[1]){case"realm":u=s[2];break;case"nonce":v=s[2];break;case"qop":l=s[2];break;case"host":z=s[2];break}}var r=m.servtype+"/"+m.domain;if(z!==null){r=r+"/"+z}var q=j.utf16to8(m.authcid+":"+u+":"+this._connection.pass);var p=h.hash(q)+":"+v+":"+y;var o="AUTHENTICATE:"+r;var w="";w+="charset=utf-8,";w+="username="+this._quote(j.utf16to8(m.authcid))+",";w+="realm="+this._quote(u)+",";w+="nonce="+this._quote(v)+",";w+="nc=00000001,";w+="cnonce="+this._quote(y)+",";w+="digest-uri="+this._quote(r)+",";w+="response="+h.hexdigest(h.hexdigest(p)+":"+v+":00000001:"+y+":auth:"+h.hexdigest(o))+",";w+="qop=auth";this.onChallenge=function(){return""};return w};f.Connection.prototype.mechanisms[f.SASLMD5.prototype.name]=f.SASLMD5;f.SASLOAuthBearer=function(){};f.SASLOAuthBearer.prototype=new f.SASLMechanism("OAUTHBEARER",true,50);f.SASLOAuthBearer.prototype.test=function(l){return l.authcid!==null};f.SASLOAuthBearer.prototype.onChallenge=function(m){var l="n,a=";l=l+m.authzid;l=l+",";l=l+"\u0001";l=l+"auth=Bearer ";l=l+m.pass;l=l+"\u0001";l=l+"\u0001";return j.utf16to8(l)};f.Connection.prototype.mechanisms[f.SASLOAuthBearer.prototype.name]=f.SASLOAuthBearer;f.SASLExternal=function(){};f.SASLExternal.prototype=new f.SASLMechanism("EXTERNAL",true,60);f.SASLExternal.prototype.onChallenge=function(l){return l.authcid===l.authzid?"":l.authzid};f.Connection.prototype.mechanisms[f.SASLExternal.prototype.name]=f.SASLExternal;return{Strophe:f,$build:i,$msg:k,$iq:e,$pres:d,SHA1:c,Base64:g,MD5:h,}}));(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-bosh",["strophe-core"],function(e){return d(e.Strophe,e.$build)})}else{return d(Strophe,$build)}}(this,function(e,d){e.Request=function(h,g,f,i){this.id=++e._requestId;this.xmlData=h;this.data=e.serialize(h);this.origFunc=g;this.func=g;this.rid=f;this.date=NaN;this.sends=i||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date){return 0}var j=new Date();return(j-this.date)/1000};this.timeDead=function(){if(!this.dead){return 0}var j=new Date();return(j-this.dead)/1000};this.xhr=this._newXHR()};e.Request.prototype={getResponse:function(){var f=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){f=this.xhr.responseXML.documentElement;if(f.tagName=="parsererror"){e.error("invalid response received");e.error("responseText: "+this.xhr.responseText);e.error("responseXML: "+e.serialize(this.xhr.responseXML));
    throw"parsererror"}}else{if(this.xhr.responseText){e.error("invalid response received");e.error("responseText: "+this.xhr.responseText);throw"badformat"}}return f},_newXHR:function(){var f=null;if(window.XMLHttpRequest){f=new XMLHttpRequest();if(f.overrideMimeType){f.overrideMimeType("text/xml; charset=utf-8")}}else{if(window.ActiveXObject){f=new ActiveXObject("Microsoft.XMLHTTP")}}f.onreadystatechange=this.func.bind(null,this);return f}};e.Bosh=function(f){this._conn=f;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this._requests=[]};e.Bosh.prototype={strip:null,_buildBody:function(){var f=d("body",{rid:this.rid++,xmlns:e.NS.HTTPBIND});if(this.sid!==null){f.attrs({sid:this.sid})}if(this._conn.options.keepalive&&this._conn._sessionCachingSupported()){this._cacheSession()}return f},_reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.errors=0;if(this._conn._sessionCachingSupported()){window.sessionStorage.removeItem("strophe-bosh-session")}this._conn.nextValidRid(this.rid)},_connect:function(j,i,g){this.wait=j||this.wait;this.hold=i||this.hold;this.errors=0;var f=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":e.NS.BOSH});if(g){f.attrs({route:g})}var h=this._conn._connect_cb;this._requests.push(new e.Request(f.tree(),this._onRequestStateChange.bind(this,h.bind(this._conn)),f.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(h,f,i,l,k,j,g){this._conn.jid=h;this.sid=f;this.rid=i;this._conn.connect_callback=l;this._conn.domain=e.getDomainFromJid(this._conn.jid);this._conn.authenticated=true;this._conn.connected=true;this.wait=k||this.wait;this.hold=j||this.hold;this.window=g||this.window;this._conn._changeConnectStatus(e.Status.ATTACHED,null)},_restore:function(g,k,j,i,f){var h=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(typeof h!=="undefined"&&h!==null&&h.rid&&h.sid&&h.jid&&(typeof g==="undefined"||g===null||e.getBareJidFromJid(h.jid)==e.getBareJidFromJid(g))){this._conn.restored=true;this._attach(h.jid,h.sid,h.rid,k,j,i,f)}else{throw {name:"StropheSessionError",message:"_restore: no restoreable session."}}},_cacheSession:function(){if(this._conn.authenticated){if(this._conn.jid&&this.rid&&this.sid){window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({"jid":this._conn.jid,"rid":this.rid,"sid":this.sid}))}}else{window.sessionStorage.removeItem("strophe-bosh-session")}},_connect_cb:function(g){var i=g.getAttribute("type");var h,j;if(i!==null&&i=="terminate"){h=g.getAttribute("condition");e.error("BOSH-Connection failed: "+h);j=g.getElementsByTagName("conflict");if(h!==null){if(h=="remote-stream-error"&&j.length>0){h="conflict"}this._conn._changeConnectStatus(e.Status.CONNFAIL,h)}else{this._conn._changeConnectStatus(e.Status.CONNFAIL,"unknown")}this._conn._doDisconnect(h);return e.Status.CONNFAIL}if(!this.sid){this.sid=g.getAttribute("sid")}var f=g.getAttribute("requests");if(f){this.window=parseInt(f,10)}var l=g.getAttribute("hold");if(l){this.hold=parseInt(l,10)}var k=g.getAttribute("wait");if(k){this.wait=parseInt(k,10)}},_disconnect:function(f){this._sendTerminate(f)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(Math.random()*4294967295);if(this._conn._sessionCachingSupported()){window.sessionStorage.removeItem("strophe-bosh-session")}this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return this._requests.length===0},_hitError:function(f){this.errors++;e.warn("request errored, status: "+f+", number of errors: "+this.errors);if(this.errors>4){this._conn._onDisconnectTimeout()}},_no_auth_received:function(g){if(g){g=g.bind(this._conn)}else{g=this._conn._connect_cb.bind(this._conn)}var f=this._buildBody();this._requests.push(new e.Request(f.tree(),this._onRequestStateChange.bind(this,g.bind(this._conn)),f.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function c(){var f;while(this._requests.length>0){f=this._requests.pop();f.abort=true;f.xhr.abort();f.xhr.onreadystatechange=function(){}}},_onIdle:function(){var h=this._conn._data;if(this._conn.authenticated&&this._requests.length===0&&h.length===0&&!this._conn.disconnecting){e.info("no requests during idle cycle, sending "+"blank request");h.push(null)}if(this._conn.paused){return}if(this._requests.length<2&&h.length>0){var f=this._buildBody();for(var g=0;g<h.length;g++){if(h[g]!==null){if(h[g]==="restart"){f.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":e.NS.BOSH})}else{f.cnode(h[g]).up()}}}delete this._conn._data;this._conn._data=[];this._requests.push(new e.Request(f.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),f.tree().getAttribute("rid")));this._throttledRequestHandler()}if(this._requests.length>0){var j=this._requests[0].age();
    if(this._requests[0].dead!==null){if(this._requests[0].timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait)){this._throttledRequestHandler()}}if(j>Math.floor(e.TIMEOUT*this.wait)){e.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(e.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler()}}},_onRequestStateChange:function(i,h){e.debug("request id "+h.id+"."+h.sends+" state changed to "+h.xhr.readyState);if(h.abort){h.abort=false;return}var g;if(h.xhr.readyState==4){g=0;try{g=h.xhr.status}catch(j){}if(typeof(g)=="undefined"){g=0}if(this.disconnecting){if(g>=400){this._hitError(g);return}}var f=(this._requests[0]==h);var k=(this._requests[1]==h);if((g>0&&g<500)||h.sends>5){this._removeRequest(h);e.debug("request id "+h.id+" should now be removed")}if(g==200){if(k||(f&&this._requests.length>0&&this._requests[0].age()>Math.floor(e.SECONDARY_TIMEOUT*this.wait))){this._restartRequest(0)}this._conn.nextValidRid(Number(h.rid)+1);e.debug("request id "+h.id+"."+h.sends+" got 200");i(h);this.errors=0}else{e.error("request id "+h.id+"."+h.sends+" error "+g+" happened");if(g===0||(g>=400&&g<600)||g>=12000){this._hitError(g);if(g>=400&&g<500){this._conn._changeConnectStatus(e.Status.DISCONNECTING,null);this._conn._doDisconnect()}}}if(!((g>0&&g<500)||h.sends>5)){this._throttledRequestHandler()}}},_processRequest:function(h){var s=this;var n=this._requests[h];var r=-1;try{if(n.xhr.readyState==4){r=n.xhr.status}}catch(l){e.error("caught an error in _requests["+h+"], reqStatus: "+r)}if(typeof(r)=="undefined"){r=-1}if(n.sends>this._conn.maxRetries){this._conn._onDisconnectTimeout();return}var g=n.age();var f=(!isNaN(g)&&g>Math.floor(e.TIMEOUT*this.wait));var j=(n.dead!==null&&n.timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait));var p=(n.xhr.readyState==4&&(r<1||r>=500));if(f||j||p){if(j){e.error("Request "+this._requests[h].id+" timed out (secondary), restarting")}n.abort=true;n.xhr.abort();n.xhr.onreadystatechange=function(){};this._requests[h]=new e.Request(n.xmlData,n.origFunc,n.rid,n.sends);n=this._requests[h]}if(n.xhr.readyState===0){e.debug("request id "+n.id+"."+n.sends+" posting");try{var q=this._conn.options.contentType||"text/xml; charset=utf-8";n.xhr.open("POST",this._conn.service,this._conn.options.sync?false:true);n.xhr.setRequestHeader&&n.xhr.setRequestHeader("Content-Type",q);if(this._conn.options.withCredentials){n.xhr.withCredentials=true}}catch(m){e.error("XHR open failed.");if(!this._conn.connected){this._conn._changeConnectStatus(e.Status.CONNFAIL,"bad-service")}this._conn.disconnect();return}var s=this;var o=function(){n.date=new Date();if(s._conn.options.customHeaders){var i=s._conn.options.customHeaders;for(var t in i){if(i.hasOwnProperty(t)){n.xhr.setRequestHeader(t,i[t])}}}window.XDomainRequest&&(n.xhr.readyState=2);n.xhr.send(n.data)};if(n.sends>1){var k=Math.min(Math.floor(e.TIMEOUT*this.wait),Math.pow(n.sends,3))*1000;setTimeout(function(){o()},k)}else{o()}n.sends++;if(this._conn.xmlOutput!==e.Connection.prototype.xmlOutput){if(n.xmlData.nodeName===this.strip&&n.xmlData.childNodes.length){this._conn.xmlOutput(n.xmlData.childNodes[0])}else{this._conn.xmlOutput(n.xmlData)}}if(this._conn.rawOutput!==e.Connection.prototype.rawOutput){this._conn.rawOutput(n.data)}}else{e.debug("_processRequest: "+(h===0?"first":"second")+" request has readyState of "+n.xhr.readyState)}},_removeRequest:function(g){e.debug("removing request");var f;for(f=this._requests.length-1;f>=0;f--){if(g==this._requests[f]){this._requests.splice(f,1)}}g.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(f){var g=this._requests[f];if(g.dead===null){g.dead=new Date()}this._processRequest(f)},_reqToData:function(f){try{return f.getResponse()}catch(g){if(g!="parsererror"){throw g}this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(h){e.info("_sendTerminate was called");var f=this._buildBody().attrs({type:"terminate"});if(h){f.cnode(h.tree())}var g=new e.Request(f.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),f.tree().getAttribute("rid"));this._requests.push(g);this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){if(!this._requests){e.debug("_throttledRequestHandler called with "+"undefined requests")}else{e.debug("_throttledRequestHandler called with "+this._requests.length+" requests")}if(!this._requests||this._requests.length===0){return}if(this._requests.length>0){this._processRequest(0)}if(this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window){this._processRequest(1)}}};return e}));(function(c,d){if(typeof define==="function"&&define.amd){define("strophe-websocket",["strophe-core"],function(e){return d(e.Strophe,e.$build)
})}else{return d(Strophe,$build)}}(this,function(d,c){d.Websocket=function(g){this._conn=g;this.strip="wrapper";var e=g.service;if(e.indexOf("ws:")!==0&&e.indexOf("wss:")!==0){var f="";if(g.options.protocol==="ws"&&window.location.protocol!=="https:"){f+="ws"}else{f+="wss"}f+="://"+window.location.host;if(e.indexOf("/")!==0){f+=window.location.pathname+e}else{f+=e}g.service=f}};d.Websocket.prototype={_buildStream:function(){return c("open",{"xmlns":d.NS.FRAMING,"to":this._conn.domain,"version":"1.0"})},_check_streamerror:function(f,l){var o;if(f.getElementsByTagNameNS){o=f.getElementsByTagNameNS(d.NS.STREAM,"error")}else{o=f.getElementsByTagName("stream:error")}if(o.length===0){return false}var m=o[0];var g="";var p="";var n="urn:ietf:params:xml:ns:xmpp-streams";for(var j=0;j<m.childNodes.length;j++){var k=m.childNodes[j];if(k.getAttribute("xmlns")!==n){break}if(k.nodeName==="text"){p=k.textContent}else{g=k.nodeName}}var h="WebSocket stream error: ";if(g){h+=g}else{h+="unknown"}if(p){h+=" - "+g}d.error(h);this._conn._changeConnectStatus(l,g);this._conn._doDisconnect();return true},_reset:function(){return},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(f){var e=this._check_streamerror(f,d.Status.CONNFAIL);if(e){return d.Status.CONNFAIL}},_handleStreamStart:function(h){var f=false;var g=h.getAttribute("xmlns");if(typeof g!=="string"){f="Missing xmlns in <open />"}else{if(g!==d.NS.FRAMING){f="Wrong xmlns in <open />: "+g}}var e=h.getAttribute("version");if(typeof e!=="string"){f="Missing version in <open />"}else{if(e!=="1.0"){f="Wrong version in <open />: "+e}}if(f){this._conn._changeConnectStatus(d.Status.CONNFAIL,f);this._conn._doDisconnect();return false}return true},_connect_cb_wrapper:function(i){if(i.data.indexOf("<open ")===0||i.data.indexOf("<?xml")===0){var j=i.data.replace(/^(<\?.*?\?>\s*)*/,"");if(j===""){return}var g=new DOMParser().parseFromString(j,"text/xml").documentElement;this._conn.xmlInput(g);this._conn.rawInput(i.data);if(this._handleStreamStart(g)){this._connect_cb(g)}}else{if(i.data.indexOf("<close ")===0){this._conn.rawInput(i.data);this._conn.xmlInput(i);var e=i.getAttribute("see-other-uri");if(e){this._conn._changeConnectStatus(d.Status.REDIRECT,"Received see-other-uri, resetting connection");this._conn.reset();this._conn.service=e;this._connect()}else{this._conn._changeConnectStatus(d.Status.CONNFAIL,"Received closing stream");this._conn._doDisconnect()}}else{var f=this._streamWrap(i.data);var h=new DOMParser().parseFromString(f,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this);this._conn._connect_cb(h,null,i.data)}}},_disconnect:function(i){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){if(i){this._conn.send(i)}var h=c("close",{"xmlns":d.NS.FRAMING});this._conn.xmlOutput(h);var f=d.serialize(h);this._conn.rawOutput(f);try{this.socket.send(f)}catch(g){d.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){d.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(e){return"<wrapper>"+e+"</wrapper>"},_closeSocket:function(){if(this.socket){try{this.socket.close()}catch(f){}}this.socket=null},_emptyQueue:function(){return true},_onClose:function(){if(this._conn.connected&&!this._conn.disconnecting){d.error("Websocket closed unexpectedly");this._conn._doDisconnect()}else{d.info("Websocket closed")}},_no_auth_received:function(e){d.error("Server did not send any auth methods");this._conn._changeConnectStatus(d.Status.CONNFAIL,"Server did not send any auth methods");if(e){e=e.bind(this._conn);e()}this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(e){d.error("Websocket error "+e);this._conn._changeConnectStatus(d.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");this._disconnect()},_onIdle:function(){var f=this._conn._data;if(f.length>0&&!this._conn.paused){for(var e=0;e<f.length;e++){if(f[e]!==null){var g,h;if(f[e]==="restart"){g=this._buildStream().tree()}else{g=f[e]}h=d.serialize(g);this._conn.xmlOutput(g);this._conn.rawOutput(h);this.socket.send(h)}}this._conn._data=[]}},_onMessage:function(f){console.log("Message: : ",f);WebIM&&WebIM.config.isDebug&&d.info(WebIM.utils.ts()+"recv:",f.data);var e,g;var h='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(f.data===h){this._conn.rawInput(h);this._conn.xmlInput(f);if(!this._conn.disconnecting){this._conn._doDisconnect()}return}else{if(f.data.search("<open ")===0){e=new DOMParser().parseFromString(f.data,"text/xml").documentElement;if(!this._handleStreamStart(e)){return}}else{g=this._streamWrap(f.data);e=new DOMParser().parseFromString(g,"text/xml").documentElement}}if(this._check_streamerror(e,d.Status.ERROR)){return
}if(this._conn.disconnecting&&e.firstChild.nodeName==="presence"&&e.firstChild.getAttribute("type")==="unavailable"){this._conn.xmlInput(e);this._conn.rawInput(d.serialize(e));return}this._conn._dataRecv(e,f.data)},_onOpen:function(){d.info("Websocket open");var f=this._buildStream();this._conn.xmlOutput(f.tree());var e=d.serialize(f);this._conn.rawOutput(e);this.socket.send(e)},_reqToData:function(e){return e},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}};return d}));(function(c){if(typeof define==="function"&&define.amd){define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],function(d){return d})}})(this);if(b){if(typeof define==="function"&&define.amd){var a=b;if(typeof requirejs==="function"){requirejs(["strophe"],function(c){a(c.Strophe,c.$build,c.$msg,c.$iq,c.$pres)})}else{require(["strophe"],function(c){a(c.Strophe,c.$build,c.$msg,c.$iq,c.$pres)})}}else{return b(Strophe,$build,$msg,$iq,$pres)}}})(function(b,e,d,a,c){window.Strophe=b;window.$build=e;window.$msg=d;window.$iq=a;window.$pres=c});